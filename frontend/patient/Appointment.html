<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>Forms / Layouts - OneLife Bootstrap Template</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon" />
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
      rel="stylesheet"
    />

    <!-- Vendor CSS Files -->
    <link
      href="assets/vendor/bootstrap/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet" />
    <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet" />
    <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet" />
    <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet" />
    <link href="assets/vendor/simple-datatables/style.css" rel="stylesheet" />

    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet" />

    </head>

  <body>
    <!-- ======= Header ======= -->
    <header id="header" class="header fixed-top d-flex align-items-center">
      <div class="d-flex align-items-center justify-content-between">
        <a href="/" class="logo d-flex align-items-center">
          <img src="assets/img/logo.png" alt="" />
          <span class="d-none d-lg-block">OneLife</span>
        </a>
        <i  class="bi bi-list toggle-sidebar-btn"></i>
      </div>
      <!-- End Logo -->
      <p style="
        border: 1px solid #6b7280;
        padding: 2px 10px;        
        border-radius: 9999px;      
        color: #4b5563;
      "><a style="color: #4b5563;" href="/admin">Admin</a></p>
      <p style="
      border: 1px solid #6b7280;
      padding: 2px 10px;        
      border-radius: 9999px;      
      color: #4b5563;
      row-gap: 10px;
    "><a style="color: #4b5563;" href="/doctor">Doctor</a></p>
     <!--v-->

      
    </header>
    <!-- End Header -->

    <!-- ======= Sidebar ======= -->
    <aside id="sidebar" class="sidebar">
      <ul class="sidebar-nav" id="sidebar-nav">
        
        <!-- End Home Nav -->

        <!--v-->

       
          <li class="nav-item">
            <a href="/" class="nav-link">
              <i class="bi bi-journal-text"></i><span>Book Appointment</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="/messages" class="nav-link collapsed">
              <i class="bi bi-calculator-fill"></i><span>Send Message</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="/registereddoctors" class="nav-link collapsed">
              <i class="bi bi-layout-text-window-reverse"></i><span>Doctors Registered</span>
            </a>
          </li>
         
        <li class="nav-item">
          <a class="nav-link collapsed" href="/Services">
            <i class="bi bi-person"></i>
            <span>Services</span>
          </a>
        </li>
        <!-- End Services Page Nav -->
        <!--v-->
        <!--v-->

        <!--v-->
        <!-- End Register Page Nav -->

        <!--v-->
        <!-- End Login Page Nav -->
        <!--v-->
        <!--v-->
      </ul>
    </aside>
    <!-- End Sidebar-->

    <main id="main" class="main">
      <div class="pagetitle">
        <h1>Book Appointment</h1>
        <nav>
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/home">Home</a></li>
            <li class="breadcrumb-item">Forms</li>
            <li class="breadcrumb-item active">Layouts</li>
          </ol>
        </nav>
      </div>
      <!-- End Page Title -->
      <section class="section">
        <div class="row">
          <div class="col-lg-6"></div>

          <div class="col-lg-12">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Book Appointment Form</h5>

               
                <form id="appointmentForm" onsubmit="payNow(event)">
                  <!-- Patient Details -->
                  <div class="mb-3">
                    <label for="fullname" class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="fullname" name="fullname" required />
                  </div>
                  <div class="mb-3">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" name="email" required />
                  </div>
                  <div class="mb-3">
                    <label for="number" class="form-label">Phone Number</label>
                    <input type="text" class="form-control" id="number" name="number" required />
                  </div>
                 
                  <!-- Appointment Details -->
                  <div class="mb-3">
                    <label for="doctor" class="form-label">Select Doctor</label>
                    <select id="doctor" class="form-select" name="doctor" required>
                      <option value="">Select Doctor</option>
                    </select>
                  </div>
                  <div class="col-2">
                    <label for="date" class="form-label">Date</label>
                    <input type="date" class="form-control" id="date" name="date" required/>
                  </div>
                  <div class="row col-12">
                    <label for="address" class="form-label">Address</label>
                    <div class="col-4">
                     <select id="country" class="form-select" name="country" onchange="fetchStates()" required>
                        <option value="">Select Country</option>
                      </select>
                    </div>
                    <div class="col-4">
                       <select id="state" class="form-select" name="state" onchange="fetchCities()" required>
                        <option value="">Select State</option>
                      </select>
                    </div>
                    <div class="col-4">
                      
                      <select id="city" class="form-select" name="city" required>
                        <option value="">Select City</option>
                      </select>
                    </div>
                   </div>
                 
                  <div class="mb-3">
                    <label for="amount" class="form-label">Payment Amount</label>
                    <input type="text" class="form-control" id="amount" name="amount" value="100" readonly />
                  </div>
                  <!-- Buttons -->
                  <button type="submit" class="btn btn-primary" id="payButton" disabled>Submit & Pay</button>
                </form>
                <!-- Vertical Form -->
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    <!-- End #main -->

    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer">
      <div class="copyright">
        &copy; Copyright <strong><span>OneLife</span></strong
        >. All Rights Reserved
      </div>
      <div class="credits">
        Designed by Somil Agrawal</a>
      </div>
    </footer>
    <!-- End Footer -->

    <a
      href="#"
      class="back-to-top d-flex align-items-center justify-content-center"
      ><i class="bi bi-arrow-up-short"></i
    ></a>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/chart.js/chart.umd.js"></script>
    <script src="assets/vendor/echarts/echarts.min.js"></script>
    <script src="assets/vendor/quill/quill.js"></script>
    <script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
    <script src="assets/vendor/tinymce/tinymce.min.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>

    <script>
      // Initialize dropdowns
      async function fetchCountries() {
        const response = await fetch('/countries');
        const countries = await response.json();
        const countrySelect = document.getElementById('country');
        countrySelect.innerHTML = '<option value="">Select Country</option>';
        countries.forEach(country => {
          const option = document.createElement('option');
          option.value = country.isoCode;
          option.textContent = country.name;
          countrySelect.appendChild(option);
        });
      }
  
      async function fetchStates() {
        const country = document.getElementById('country').value;
        const response = await fetch(`/states/${country}`);
        const states = await response.json();
        const stateSelect = document.getElementById('state');
        stateSelect.innerHTML = '<option value="">Select State</option>';
        states.forEach(state => {
          const option = document.createElement('option');
          option.value = state.isoCode;
          option.textContent = state.name;
          stateSelect.appendChild(option);
        });
      }
  
      async function fetchCities() {
        const country = document.getElementById('country').value;
        const state = document.getElementById('state').value;
        const response = await fetch(`/cities/${country}/${state}`);
        const cities = await response.json();
        const citySelect = document.getElementById('city');
        citySelect.innerHTML = '<option value="">Select City</option>';
        cities.forEach(city => {
          const option = document.createElement('option');
          option.value = city.name;
          option.textContent = city.name;
          citySelect.appendChild(option);
        });
      }
  
      async function fetchDoctors() {
        const response = await fetch('/doctors');
        const doctors = await response.json();
        const doctorSelect = document.getElementById('doctor');
        doctorSelect.innerHTML = '<option value="">Select Doctor</option>';
        doctors.forEach(doctor => {
          const option = document.createElement('option');
          option.value = `${doctor.fullname}|${doctor._id}`;
          option.textContent = doctor.fullname;
          doctorSelect.appendChild(option);
        });
      }
  
      // Razorpay integration
      async function payNow(event) {
  event.preventDefault();

  const form = document.getElementById("appointmentForm");
  const formData = new FormData(form);
  const payload = Object.fromEntries(formData.entries());

  try {
    const response = await fetch("/appointment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const { appointmentId, razorpayOrderId } = await response.json();

    const options = {
      key: "rzp_test_8Tg095AU86SIcj",
      amount: payload.amount * 100,
      currency: "INR",
      name: "Your App Name",
      description: "Appointment Payment",
      order_id: razorpayOrderId,
      handler: async function (response) {
        // Save payment info
        await fetch("/save-payment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            appointmentId,
            paymentId: response.razorpay_payment_id,
          }),
        });

        window.location.href = "/payment-success";
      },
    };

    const razorpay = new Razorpay(options);
    razorpay.open();
  } catch (error) {
    console.error("Error:", error);
  }
}
     // Enable submit button
      document.getElementById('appointmentForm').addEventListener('input', () => {
        const isFormValid = document.getElementById('appointmentForm').checkValidity();
        document.getElementById('payButton').disabled = !isFormValid;
      });
  
      // Onload setup
      window.onload = () => {
        fetchCountries();
        fetchDoctors();
      };
    </script>
  </body>
</html>
